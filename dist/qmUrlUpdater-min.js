function removeTextAfter(e){e=(e=e.split("?tag")[0]).split("&tag")[0]}function insertParam(e,t,r){if(-1==e.indexOf("redirect.html")){var n=-1===(e=e.split("?tag")[0]).indexOf("?")?"?":"&";if(-1!=e.indexOf("?tag")){var o,a=e.split("&"),i=a.length;for(t=escape(t),r=escape(r);i--;)if((o=a[i].split("="))[0]==t){o[1]=r,a[i]=o.join("=");break}return i<0&&(a[a.length]=[t,r].join("=")),a.join("&")}return-1!=e.indexOf("ref=dp_iou_view_this_order?")?e=e+n+[t,r].join("="):-1!=e.indexOf("ref=sr_")?e=e+n+[t,r].join("="):-1!=e.indexOf("ref=")?e=e+n+[t,r].join("="):-1!=e.indexOf("&tag")?(e=e.split("&tag")[0],e=e+n+[t,r].join("=")):e=e+n+[t,r].join("=")}}var _key="tag",_trackIdKey="trackId",_trackIdKeyDefault="trackIdDefault",_trackIdKeyCa="trackId.ca",_trackIdKeyDefaultCa="trackIdDefault.ca",_trackIdKeyUk="trackId.co.uk",_trackIdKeyDefaultUk="trackIdDefault.co.uk",_trackIdKeyDe="trackId.de",_trackIdKeyDefaultDe="trackIdDefault.de",_trackIdKeyEs="trackId.es",_trackIdKeyDefaultEs="trackIdDefault.es",_trackIdKeyFr="trackId.fr",_trackIdKeyDefaultFr="trackIdDefault.fr",_trackIdKeyIt="trackId.it",_trackIdKeyDefaultIt="trackIdDefault.it",_trackIdKeyJp="trackId.co.jp",_trackIdKeyDefaultJp="trackIdDefault.co.jp",_trackIdKeyCn="trackId.cn",_trackIdKeyDefaultCn="trackIdDefault.cn";localStorage[_trackIdKeyDefault]="quant08-20",localStorage[_trackIdKeyDefaultCa]="quantimodo-20",localStorage[_trackIdKeyDefaultUk]="quantimodo-21",localStorage[_trackIdKeyDefaultDe]="quantimodo01-21",localStorage[_trackIdKeyDefaultEs]="quantimodo05-21",localStorage[_trackIdKeyDefaultFr]="quantimodo0f6-21",localStorage[_trackIdKeyDefaultIt]="quantimodo08-21",localStorage[_trackIdKeyDefaultJp]="quantimodo05-21",localStorage[_trackIdKeyDefaultCn]="quantimodo-20",chrome.browserAction.onClicked.addListener(function(e){chrome.tabs.create({url:"http://www.amazon.com/deals",selected:!0},function(e){})}),chrome.webRequest.onBeforeRequest.addListener(function(e){if(window==top){var t=localStorage[_trackIdKey];if(t||(t=localStorage[_trackIdKeyDefault]),-1==e.url.search(t)&&-1==e.url.search("ap/signin")&&-1==e.url.search("ap/widget"))return{redirectUrl:insertParam(e.url,_key,t)}}},{urls:["http://www.amazon.com/*","https://www.amazon.com/*"]},["blocking"]),chrome.webRequest.onBeforeRequest.addListener(function(e){if(window==top){var t=localStorage[_trackIdKeyCa];if(t||(t=localStorage[_trackIdKeyDefaultCa]),-1==e.url.search(t)&&-1==e.url.search("ap/signin")&&-1==e.url.search("ap/widget"))return{redirectUrl:insertParam(e.url,_key,t)}}},{urls:["http://www.amazon.ca/*","https://www.amazon.ca/*"]},["blocking"]),chrome.webRequest.onBeforeRequest.addListener(function(e){if(window==top){var t=localStorage[_trackIdKeyUk];if(t||(t=localStorage[_trackIdKeyDefaultUk]),-1==e.url.search(t)&&-1==e.url.search("ap/signin")&&-1==e.url.search("ap/widget"))return{redirectUrl:insertParam(e.url,_key,t)}}},{urls:["http://www.amazon.co.uk/*","https://www.amazon.co.uk/*"]},["blocking"]),chrome.webRequest.onBeforeRequest.addListener(function(e){if(window==top){var t=localStorage[_trackIdKeyDe];if(t||(t=localStorage[_trackIdKeyDefaultDe]),-1==e.url.search(t)&&-1==e.url.search("ap/signin")&&-1==e.url.search("ap/widget"))return{redirectUrl:insertParam(e.url,_key,t)}}},{urls:["http://www.amazon.de/*","https://www.amazon.de/*"]},["blocking"]),chrome.webRequest.onBeforeRequest.addListener(function(e){if(window==top){var t=localStorage[_trackIdKeyEs];if(t||(t=localStorage[_trackIdKeyDefaultEs]),-1==e.url.search(t)&&-1==e.url.search("ap/signin")&&-1==e.url.search("ap/widget"))return{redirectUrl:insertParam(e.url,_key,t)}}},{urls:["http://www.amazon.es/*","https://www.amazon.es/*"]},["blocking"]),chrome.webRequest.onBeforeRequest.addListener(function(e){if(window==top){var t=localStorage[_trackIdKeyFr];if(t||(t=localStorage[_trackIdKeyDefaultFr]),-1==e.url.search(t)&&-1==e.url.search("ap/signin")&&-1==e.url.search("ap/widget"))return{redirectUrl:insertParam(e.url,_key,t)}}},{urls:["http://www.amazon.fr/*","https://www.amazon.fr/*"]},["blocking"]),chrome.webRequest.onBeforeRequest.addListener(function(e){if(window==top){var t=localStorage[_trackIdKeyIt];if(t||(t=localStorage[_trackIdKeyDefaultIt]),-1==e.url.search(t)&&-1==e.url.search("ap/signin")&&-1==e.url.search("ap/widget"))return{redirectUrl:insertParam(e.url,_key,t)}}},{urls:["http://www.amazon.it/*","https://www.amazon.it/*"]},["blocking"]),chrome.webRequest.onBeforeRequest.addListener(function(e){if(window==top){var t=localStorage[_trackIdKeyJp];if(t||(t=localStorage[_trackIdKeyDefaultJp]),-1==e.url.search(t)&&-1==e.url.search("ap/signin")&&-1==e.url.search("ap/widget"))return{redirectUrl:insertParam(e.url,_key,t)}}},{urls:["http://www.amazon.co.jp/*","https://www.amazon.co.jp/*"]},["blocking"]),chrome.webRequest.onBeforeRequest.addListener(function(e){if(window==top){var t=localStorage[_trackIdKeyCn];if(t||(t=localStorage[_trackIdKeyDefaultCn]),-1==e.url.search(t)&&-1==e.url.search("ap/signin")&&-1==e.url.search("ap/widget"))return{redirectUrl:insertParam(e.url,_key,t)}}},{urls:["http://www.amazon.cn/*","https://www.amazon.cn/*"]},["blocking"]);var amazon_order_history_table=function(){"use strict";function e(e,a){console.log("amazon_order_history_table.reallyDisplayOrders starting");amazon_order_history_util.clearHeaders(),amazon_order_history_util.clearBody();var s=function(e){var t,a,s,l,c,u,d,h=function(e,t,n){var o=e.ownerDocument.createElement("th");return o.setAttribute("style",r),e.appendChild(o),o.textContent=t,n&&o.setAttribute("title",n),o};return null!==(t=document.querySelector('[id="order_table"]'))&&(console.log("removing old table"),t.parentNode.removeChild(t),console.log("removed old table")),console.log("adding table"),t=document.createElement("table"),console.log("added table"),document.body.appendChild(t),t.setAttribute("id","order_table"),t.setAttribute("class","order_reporter_table stripe compact"),t.setAttribute("style",r),a=document.createElement("thead"),t.appendChild(a),s=document.createElement("tr"),a.appendChild(s),l=document.createElement("tfoot"),t.appendChild(l),c=document.createElement("tr"),l.appendChild(c),d=amazon_order_history_util.getSite().endsWith(".com"),i.forEach(function(e){var t=e.field_name;d&&"vat"===t&&(e.field_name="tax"),d&&"postage"===t&&(e.field_name="shipping"),h(s,e.field_name,e.help),h(c,e.field_name,e.help)}),u=document.createElement("tbody"),t.appendChild(u),e.forEach(function(e){!function(e,t){var a=document.createElement("tr");a.setAttribute("style",r),e.appendChild(a),i.forEach(function(e){var r=null;switch(e.type){case"plain":r=o(a,t[e.property_name]);break;case"detail":r=o(a,"pending"),t.detail_promise.then(function(t){r.innerHTML=t[e.property_name],n&&(n.rows().invalidate(),n.draw())});break;case"payments":r=o(a,"pending"),t.payments_promise.then(function(e){var o=document.createElement("ul");e.forEach(function(e){var r=document.createElement("li");o.appendChild(r);var n=document.createElement("a");r.appendChild(n),n.textContent=e+"; ",n.href=amazon_order_history_util.getOrderPaymentUrl(t.id)}),r.textContent="",r.appendChild(o),n&&(n.rows().invalidate(),n.draw())});break;case"func":e.func(t,a)}"help"in e&&r.setAttribute("title",e.help)})}(u,e),console.log("Added row for "+e.id)}),t}(e);return a?$(document).ready(function(){n=$("#order_table").DataTable({bPaginate:!0,lengthMenu:[[10,25,50,100,-1],[10,25,50,100,"All"]],footerCallback:function(e,t,r,n,o){var a=this.api(),s=function(e){return"string"==typeof e?"N/A"===e?0:parseFloat(e.replace(/^([Â£$]|CAD|EUR) */,"").replace(/,/,".")):"number"==typeof e?e:0},l=0;i.forEach(function(e){e.is_numeric&&(e.sum=a.column(l).data().reduce(function(e,t){return s(e)+s(t)}),e.pageSum=a.column(l,{page:"current"}).data().reduce(function(e,t){return s(e)+s(t)},0),$(a.column(l).footer()).html(sprintf("page sum=%s; all=%s",e.pageSum.toFixed(2),e.sum.toFixed(2)))),l+=1})}}),amazon_order_history_util.removeButton("data table"),amazon_order_history_util.addButton("plain table",function(){console.log("amazon_order_history_table plain table button clicked"),t(e,!1)},"background-color:cornflowerblue; color:white")}):(amazon_order_history_util.removeButton("plain table"),amazon_order_history_util.addButton("data table",function(){console.log("amazon_order_history_table data table button clicked"),t(e,!0)},"background-color:cornflowerblue; color:white")),console.log("amazon_order_history_table.reallyDisplayOrders returning"),s}function t(t,r){return console.log("amazon_order_history_table.displayOrders starting"),Promise.all(t).then(function(t){for(var n=0;n<t.length;n++){t[n];localStorage.measurementQueue.push()}console.log("amazon_order_history_table.displayOrders then func starting");var o=e(t,r);return console.log("amazon_order_history_table.displayOrders then func returning"),o})}var r="border: 1px solid black;",n=null,o=function(e,t){var n=e.ownerDocument.createElement("td");return n.setAttribute("style",r),e.appendChild(n),n.textContent=t,n},a=function(e,t){var n=e.ownerDocument.createElement("td");return n.setAttribute("style",r),e.appendChild(n),n.appendChild(t),n},i=[{field_name:"order id",type:"func",func:function(e,t){!function(e,t,r){var n=e.ownerDocument.createElement("a");n.textContent=t,n.href=r,a(e,n)}(t,e.id,amazon_order_history_util.getOrderDetailUrl(e.id))},is_numeric:!1},{field_name:"items",type:"func",func:function(e,t){a(t,e.itemsHtml(document))},is_numeric:!1},{field_name:"to",type:"plain",property_name:"who",is_numeric:!1},{field_name:"date",type:"plain",property_name:"date",is_numeric:!1},{field_name:"total",type:"plain",property_name:"total",is_numeric:!0},{field_name:"postage",type:"detail",property_name:"postage",is_numeric:!0,help:"If there are only N/A values in this column, your login session may have partially expired, meaning you (and the extension) cannot fetch order details. Try clicking on one of the order links in the left hand column and then retrying the extension button you clicked to get here."},{field_name:"gift",type:"detail",property_name:"gift",is_numeric:!0},{field_name:"vat",type:"detail",property_name:"vat",is_numeric:!0,help:"Caution: when stuff is not supplied by Amazon, then tax is often not listed."},{field_name:"payments",type:"payments",property_name:"payments",is_numeric:!1}];return{displayOrders:t}}();!function(e){function t(){var e=arguments[0],r=t.cache;return r[e]&&r.hasOwnProperty(e)||(r[e]=t.parse(e)),t.format.call(null,r[e],arguments)}function r(e){return Object.prototype.toString.call(e).slice(8,-1).toLowerCase()}var n={not_string:/[^s]/,number:/[dief]/,text:/^[^\x25]+/,modulo:/^\x25{2}/,placeholder:/^\x25(?:([1-9]\d*)\$|\(([^\)]+)\))?(\+)?(0|'[^$])?(-)?(\d+)?(?:\.(\d+))?([b-fiosuxX])/,key:/^([a-z_][a-z_\d]*)/i,key_access:/^\.([a-z_][a-z_\d]*)/i,index_access:/^\[(\d+)\]/,sign:/^[\+\-]/};t.format=function(e,o){var a,i,s,l,c,u,d,h=1,p=e.length,f="",m=[],_=!0,g="";for(i=0;i<p;i++)if("string"===(f=r(e[i])))m[m.length]=e[i];else if("array"===f){if((l=e[i])[2])for(a=o[h],s=0;s<l[2].length;s++){if(!a.hasOwnProperty(l[2][s]))throw new Error(t("[sprintf] property '%s' does not exist",l[2][s]));a=a[l[2][s]]}else a=l[1]?o[l[1]]:o[h++];if("function"==r(a)&&(a=a()),n.not_string.test(l[8])&&"number"!=r(a)&&isNaN(a))throw new TypeError(t("[sprintf] expecting number but found %s",r(a)));switch(n.number.test(l[8])&&(_=a>=0),l[8]){case"b":a=a.toString(2);break;case"c":a=String.fromCharCode(a);break;case"d":case"i":a=parseInt(a,10);break;case"e":a=l[7]?a.toExponential(l[7]):a.toExponential();break;case"f":a=l[7]?parseFloat(a).toFixed(l[7]):parseFloat(a);break;case"o":a=a.toString(8);break;case"s":a=(a=String(a))&&l[7]?a.substring(0,l[7]):a;break;case"u":a>>>=0;break;case"x":a=a.toString(16);break;case"X":a=a.toString(16).toUpperCase()}!n.number.test(l[8])||_&&!l[3]?g="":(g=_?"+":"-",a=a.toString().replace(n.sign,"")),u=l[4]?"0"===l[4]?"0":l[4].charAt(1):" ",d=l[6]-(g+a).length,c=l[6]&&d>0?function(e,t){return Array(t+1).join(e)}(u,d):"",m[m.length]=l[5]?g+a+c:"0"===u?g+c+a:c+g+a}return m.join("")},t.cache={},t.parse=function(e){for(var t=e,r=[],o=[],a=0;t;){if(null!==(r=n.text.exec(t)))o[o.length]=r[0];else if(null!==(r=n.modulo.exec(t)))o[o.length]="%";else{if(null===(r=n.placeholder.exec(t)))throw new SyntaxError("[sprintf] unexpected placeholder");if(r[2]){a|=1;var i=[],s=r[2],l=[];if(null===(l=n.key.exec(s)))throw new SyntaxError("[sprintf] failed to parse named argument key");for(i[i.length]=l[1];""!==(s=s.substring(l[0].length));)if(null!==(l=n.key_access.exec(s)))i[i.length]=l[1];else{if(null===(l=n.index_access.exec(s)))throw new SyntaxError("[sprintf] failed to parse named argument key");i[i.length]=l[1]}r[2]=i}else a|=2;if(3===a)throw new Error("[sprintf] mixing positional and named placeholders is not (yet) supported");o[o.length]=r}t=t.substring(r[0].length)}return o};var o=function(e,r,n){return(n=(r||[]).slice(0)).splice(0,0,e),t.apply(null,n)};"undefined"!=typeof exports?(exports.sprintf=t,exports.vsprintf=o):(e.sprintf=t,e.vsprintf=o,"function"==typeof define&&define.amd&&define(function(){return{sprintf:t,vsprintf:o}}))}("undefined"==typeof window?this:window);var amazon_order_history_util=function(){"use strict";function e(){var e=window.location.href;return/https:\/\/((www|smile)\.amazon\.[^\/]+)/.exec(e)[1]}return{addButton:function(e,t,r){var n=document.querySelector('[button_name="'+e+'"]');null!==n&&n.parentNode.removeChild(n);var o=document.createElement("button");void 0===r&&(r="background-color:orange; color:white"),o.innerText=e,o.setAttribute("style",r),o.setAttribute("class","order_reporter_button"),o.setAttribute("button_name",e),o.onclick=t,document.body.insertBefore(o,document.body.firstChild)},clearBody:function(){Array.from(document.body.children).forEach(function(e){e.hasAttribute("class")&&e.getAttribute("class").includes("order_reporter_")||document.body.removeChild(e)})},clearHeaders:function(){for(;document.head.firstChild;)document.head.removeChild(document.head.firstChild)},findMultipleNodeValues:function(t,r,n){var o;try{o=r.evaluate(t,n,null,XPathResult.ORDERED_NODE_SNAPSHOT_TYPE,null)}catch(t){return log('Error: maybe you"re not logged into https://'+e()+"/gp/css/order-history "+t),[]}var a,i=[];for(a=0;a!==o.snapshotLength;a+=1)i.push(o.snapshotItem(a));return i},findSingleNodeValue:function(e,t,r){return t.evaluate(e,r,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue},getOrderDetailUrl:function(t){return"https://"+e()+"/gp/your-account/order-details/ref=oh_aui_or_o01_?ie=UTF8&orderID="+t},getOrderPaymentUrl:function(t){return t.startsWith("D")?"https://"+e()+"/gp/digital/your-account/order-summary.html?ie=UTF8&orderID="+t+"&print=1&":"https://"+e()+"/gp/css/summary/print.html/ref=oh_aui_ajax_pi?ie=UTF8&orderID="+t},getSite:e,removeButton:function(e){var t=document.querySelector('[button_name="'+e+'"]');null!==t&&t.parentNode.removeChild(t)}}}(),amazon_order_history_request_scheduler=function(){"use strict";class e{constructor(e){this.content=[],this.scoreFunction=e}push(e){this.content.push(e),this.bubbleUp(this.content.length-1)}pop(){var e=this.content[0],t=this.content.pop();return this.content.length>0&&(this.content[0]=t,this.sinkDown(0)),e}remove(e){for(var t=this.content.length,r=0;r<t;r++)if(this.content[r]==e){var n=this.content.pop();if(r==t-1)break;this.content[r]=n,this.bubbleUp(r),this.sinkDown(r);break}}size(){return this.content.length}bubbleUp(e){for(var t=this.content[e],r=this.scoreFunction(t);e>0;){var n=Math.floor((e+1)/2)-1,o=this.content[n];if(r>=this.scoreFunction(o))break;this.content[n]=t,this.content[e]=o,e=n}}sinkDown(e){for(var t=this.content.length,r=this.content[e],n=this.scoreFunction(r);;){var o=2*(e+1),a=o-1,i=null,s=null;if(a<t){var l=this.content[a];(s=this.scoreFunction(l))<n&&(i=a)}if(o<t){var c=this.content[o];this.scoreFunction(c)<(null==i?n:s)&&(i=o)}if(null==i)break;this.content[e]=this.content[i],this.content[i]=r,e=i}}}return{create:function(){return new class{constructor(){this.CONCURRENCY=6,this.queue=new e(function(e){return e.priority}),this.running_count=0,this.completed_count=0,this.error_count=0,this.execute=function(e,t){console.log("Executing "+e+" with queue size "+this.queue.size());var r=new XMLHttpRequest;r.open("GET",e,!0),r.onerror=function(){this.running_count-=1,this.error_count+=1,console.log("Unknown error fetching "+e)},r.onload=function(n){if(this.running_count-=1,200!=r.status)return this.error_count+=1,void console.log("Got HTTP"+r.status+" fetching "+e);for(this.completed_count+=1,console.log("Finished "+e+" with queue size "+this.queue.size());this.running_count<this.CONCURRENCY&&this.queue.size()>0;){var o=this.queue.pop();this.execute(o.query,o.callback)}t(n)}.bind(this),this.running_count+=1,r.send(),this.updateProgress()},this.statistics=function(){return{queued:this.queue.size(),running:this.running_count,completed:this.completed_count,errors:this.error_count}},this.updateProgress=function(){var e=document.getElementById("order_reporter_progress");null!=e&&(e.textContent=Object.entries(this.statistics()).map(([e,t])=>e+":"+t).join("; ")),setTimeout(function(){this.updateProgress()}.bind(this),2e3)},this.updateProgress()}schedule(e,t,r){console.log("Scheduling "+e+" with "+this.queue.size()),this.running_count<this.CONCURRENCY?this.execute(e,t):this.queue.push({query:e,callback:t,priority:r})}}}}}(),amazon_order_history_inject=function(){"use strict";function e(){if(void 0===e.years){var t=amazon_order_history_util.findMultipleNodeValues('//select[@name="orderFilter"]/option[@value]',document,document);e.years=t.map(function(e){return e.textContent.replace("nel","").trim()}).filter(function(e,t,r){return/^\d+$/.test(e)})}return e.years}function t(e){return amazon_order_history_order.getOrdersByYear(e,r).then(function(e){return amazon_order_history_table.displayOrders(e,!0),document.querySelector('[id="order_table"]')})}var r=amazon_order_history_request_scheduler.create();!function(){var r=e();r.length>0&&amazon_order_history_util.addButton("All years",function(){t(r)}),r.forEach(function(e){amazon_order_history_util.addButton([e],function(){t([e])})})}(),function(){var e=document.createElement("div");e.setAttribute("id","order_reporter_progress"),e.setAttribute("class","order_reporter_progress"),e.setAttribute("style","position:absolute; top:0; right:0; color:orange; padding:0.2em; font-size:75%"),document.body.insertBefore(e,document.body.firstChild)}(),console.log("Starting")}(),amazon_order_history_order=function(){"use strict";function e(e,t,r){var n=amazon_order_history_util.findSingleNodeValue(e,t,r);try{return n.textContent.trim()}catch(e){return"?"}}class t{constructor(e,t){this.year=e,this.expected_order_count=null,this.order_found_callback=null,this.query_string_templates={"www.amazon.co.uk":"https://%(site)s/gp/css/order-history?opt=ab&digitalOrders=1&unifiedOrders=1&returnTo=&orderFilter=year-%(year)s&startIndex=%(startOrderPos)s","smile.amazon.co.uk":"https://%(site)s/gp/css/order-history?opt=ab&digitalOrders=1&unifiedOrders=1&returnTo=&orderFilter=year-%(year)s&startIndex=%(startOrderPos)s","www.amazon.de":"https://%(site)s/gp/css/order-history?opt=ab&digitalOrders=1&unifiedOrders=1&returnTo=&orderFilter=year-%(year)s&startIndex=%(startOrderPos)s&language=en_GB","www.amazon.it":"https://%(site)s/gp/css/order-history?opt=ab&digitalOrders=1&unifiedOrders=1&returnTo=&orderFilter=year-%(year)s&startIndex=%(startOrderPos)s&language=en_GB","smile.amazon.ca":"https://%(site)s/gp/css/order-history?opt=ab&digitalOrders=1&&unifiedOrders=1&returnTo=&orderFilter=year-%(year)s&startIndex=%(startOrderPos)s","www.amazon.ca":"https://%(site)s/gp/css/order-history?opt=ab&digitalOrders=1&&unifiedOrders=1&returnTo=&orderFilter=year-%(year)s&startIndex=%(startOrderPos)s","smile.amazon.fr":"https://%(site)s/gp/css/order-history?opt=ab&digitalOrders=1&&unifiedOrders=1&returnTo=&orderFilter=year-%(year)s&startIndex=%(startOrderPos)s","smile.amazon.com":"https://%(site)s/gp/css/order-history?opt=ab&digitalOrders=1&&unifiedOrders=1&returnTo=&orderFilter=year-%(year)s&startIndex=%(startOrderPos)s","www.amazon.com":"https://%(site)s/gp/your-account/order-history?ie=UTF8&orderFilter=year-%(year)s&startIndex=%(startOrderPos)s&unifiedOrders=1"},this.orderPromises=[],this.sendGetOrderCount=function(){t.schedule(this.generateQueryString(0),this.receiveGetOrderCount.bind(this),"00000")},this.generateQueryString=function(e){var t=this.query_string_templates[amazon_order_history_util.getSite()];return sprintf(t,{site:amazon_order_history_util.getSite(),year:this.year,startOrderPos:e})},this.receiveGetOrderCount=function(e){var r,n=(new DOMParser).parseFromString(e.target.responseText,"text/html"),o=amazon_order_history_util.findSingleNodeValue('.//span[@class="num-orders"]',n,n);for(this.expected_order_count=parseInt(o.textContent.split(" ")[0],10),console.log("Found "+this.expected_order_count+" orders for "+this.year),this.unfetched_count=this.expected_order_count,isNaN(this.unfetched_count)&&(console.warn("Error: cannot find order count in "+o.textContent),this.unfetched_count=0),r=10;r<this.expected_order_count;r+=10)t.schedule(this.generateQueryString(r),this.receiveOrdersPage.bind(this),"2");this.receiveOrdersPage(e)},this.receiveOrdersPage=function(e){var r,n=(new DOMParser).parseFromString(e.target.responseText,"text/html");try{r=n.getElementById("ordersContainer")}catch(e){return void console.warn('Error: maybe you"re not logged into https://'+amazon_order_history_util.getSite()+"/gp/css/order-history "+e)}amazon_order_history_util.findMultipleNodeValues('.//*[contains(concat(" ", normalize-space(@class), " "), " order ")]',n,r).forEach(function(e){this.order_found_callback(function(e){return new Promise(function(r,n){r(amazon_order_history_order.create(e,t))})}(e))}.bind(this))},this.ordersPromise=new Promise(function(e,t){this.order_found_callback=function(t){this.orderPromises.push(t),t.then(function(e){console.log("amazon_order_history_order Fetching "+e.id)}),console.log("YearFetcher orderPromises.length:"+this.orderPromises.length+" expected_order_count:"+this.expected_order_count),this.orderPromises.length===this.expected_order_count&&e(this.orderPromises)},this.sendGetOrderCount()}.bind(this))}}return{create:function(t,r){return new class{constructor(e,t){this.id=null,this.date=null,this.total=null,this.who=null,this.detail_promise=null,this.items=null,this.request_scheduler=t,this.extractOrder(e)}extractOrder(t){var r=t.ownerDocument;this.date=e('.//div[contains(span,"Order placed")]/../div/span[contains(@class,"value")]',r,t),this.total=e('.//div[contains(span,"Total")]/../div/span[contains(@class,"value")]',r,t),this.who=e('.//div[contains(@class,"recipient")]//span[@class="trigger-text"]',r,t),"?"===this.who&&(this.who="N/A"),this.id=e('.//div[contains(@class,"a-row")][span[contains(@class,"label")]][span[contains(@class,"value")]][contains(span,"Order #")]/span[contains(@class,"value")]',r,t),this.items=function(e){var t={};return amazon_order_history_util.findMultipleNodeValues('.//div[@class="a-row"]/a[@class="a-link-normal"][contains(@href,"/gp/product/")]',e.ownerDocument,e).forEach(function(e){var r=e.innerText.replace(/[\n\r]/g," ").replace(/  */g," ").trim(),n=e.getAttribute("href");t[r]=n}),t}(t),this.detail_promise=new Promise(function(t,r){var n=amazon_order_history_util.getOrderDetailUrl(this.id),o=function(r){var n=(new DOMParser).parseFromString(r.target.responseText,"text/html"),o=function(){var t,r=e('//div[contains(@id,"od-subtotals")]//span[contains(text(),"Gift")]/parent::div/following-sibling::div/span',n,n.documentElement);return"?"!==r?r.replace("-",""):null!==(r=e('//*[text()[contains(.,"Gift Certificate")]]',n,n.documentElement))&&null!==(t=r.match(/Gift Certificate.Card Amount: *([$Â£â¬0-9.]*)/))?t[1]:null!==(r=e('//*[text()[contains(.,"Gift Card")]]',n,n.documentElement))&&null!==(t=r.match(/Gift Card Amount: *([$Â£â¬0-9.]*)/))?t[1]:"N/A"}.bind(this),a=function(){var t=e('//div[contains(@id,"od-subtotals")]//span[contains(text(),"Postage")]/parent::div/following-sibling::div/span',n,n.documentElement);return"?"!==t?t:"?"!==(t=e('//div[contains(@id,"od-subtotals")]//span[contains(text(),"Shipping")]/parent::div/following-sibling::div/span',n,n.documentElement))?t:"N/A"}.bind(this),i=function(){var t=e('//div[contains(@id,"od-subtotals")]//span[contains(text(),"VAT") and not(contains(.,"Before"))]/parent::div/following-sibling::div/span',n,n.documentElement);if("?"!==t)return t;if("?"!==(t=e('//div[contains(@id,"od-subtotals")]//span[contains(text(),"tax") and not(contains(.,"before"))]/parent::div/following-sibling::div/span',n,n.documentElement)))return t;if(null!==(t=e('//*[text()[contains(.,"VAT") and not(contains(.,"Before"))]]',n,n.documentElement))){var r=t.match(/VAT: *([-$Â£â¬0-9.]*)/);if(null!==r)return r[1]}if(null!==(t=e('//div[contains(@class,"a-row pmts-summary-preview-single-item-amount")]//span[contains(text(),"VAT")]/parent::div/following-sibling::div/span',n,n.documentElement))){var o=t.match(/VAT: *([-$Â£â¬0-9.]*)/);if(null!==o)return o[1]}return"N/A"}.bind(this);t({postage:a(),gift:o(),vat:i()})}.bind(this);this.request_scheduler.schedule(n,o,this.id)}.bind(this)),this.payments_promise=new Promise(function(e,t){if(this.id.startsWith("D"))e([this.date+": "+this.total]);else{var r=amazon_order_history_util.getOrderPaymentUrl(this.id),n=function(t){var r=(new DOMParser).parseFromString(t.target.responseText,"text/html"),n=amazon_order_history_util.findMultipleNodeValues('//b[contains(text(),"Credit Card transactions")]/../../..//td[contains(text(),":")]/..',r,r).map(function(e){return e.textContent.replace(/[\n\r]/g," ").replace(/  */g,"Â ").trim()});e(n)}.bind(this);this.request_scheduler.schedule(r,n,this.id)}}.bind(this))}itemsHtml(e){var t,r,n,o=e.createElement("ul");for(t in this.items)this.items.hasOwnProperty(t)&&(r=e.createElement("li"),o.appendChild(r),n=e.createElement("a"),r.appendChild(n),n.textContent=t+"; ",n.href=this.items[t]);return o}}(t,r)},getOrdersByYear:function(e,r){return new Promise((n,o)=>{Promise.all(e.map(function(e){return new t(e,r).ordersPromise})).then(function(e){var t=[].concat.apply([],e);n(t)})})}}}(),amazon_order_history_csv=function(){"use strict";return{download:function(e){var t=function(e){for(var t=e.rows,r=[],n=0;n<t.length;++n){for(var o=t[n].cells,a=[],i=0;i<o.length;++i)a.push(o[i].textContent);r.push(a)}return r}(e).map(function(e){return e.map(function(e){if(null===e)return"";var t=e.replace(/"/g,'""');return t.search(/("|,|\n)/g)>=0&&(t='"'+t+'"'),t}).join(",")}).join("\n"),r=new Blob([t],{type:"text/csv;charset=utf-8;"}),n=document.createElement("a"),o=URL.createObjectURL(r);n.setAttribute("href",o),n.setAttribute("download","amazon_order_history.csv"),n.style.visibility="hidden",document.body.appendChild(n),n.click(),document.body.removeChild(n)}}}();